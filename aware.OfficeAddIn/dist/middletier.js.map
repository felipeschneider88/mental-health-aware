{"version":3,"file":"middletier.js","mappings":"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","sources":["webpack://office-addin-taskpane-sso-js/./src/middle-tier/msgraph-helper.js","webpack://office-addin-taskpane-sso-js/./src/middle-tier/ssoauth-helper.js","webpack://office-addin-taskpane-sso-js/external commonjs \"cookie-parser\"","webpack://office-addin-taskpane-sso-js/external commonjs \"dotenv\"","webpack://office-addin-taskpane-sso-js/external commonjs \"express\"","webpack://office-addin-taskpane-sso-js/external commonjs \"form-urlencoded\"","webpack://office-addin-taskpane-sso-js/external commonjs \"http-errors\"","webpack://office-addin-taskpane-sso-js/external commonjs \"jsonwebtoken\"","webpack://office-addin-taskpane-sso-js/external commonjs \"jwks-rsa\"","webpack://office-addin-taskpane-sso-js/external commonjs \"morgan\"","webpack://office-addin-taskpane-sso-js/external commonjs \"node-fetch\"","webpack://office-addin-taskpane-sso-js/external commonjs \"office-addin-dev-certs\"","webpack://office-addin-taskpane-sso-js/external commonjs \"path\"","webpack://office-addin-taskpane-sso-js/external node-commonjs \"https\"","webpack://office-addin-taskpane-sso-js/webpack/bootstrap","webpack://office-addin-taskpane-sso-js/webpack/runtime/compat get default export","webpack://office-addin-taskpane-sso-js/webpack/runtime/define property getters","webpack://office-addin-taskpane-sso-js/webpack/runtime/hasOwnProperty shorthand","webpack://office-addin-taskpane-sso-js/webpack/runtime/make namespace object","webpack://office-addin-taskpane-sso-js/./src/middle-tier/app.js"],"sourcesContent":["// Copyright (c) Microsoft. All rights reserved. Licensed under the MIT license. See full license in the root of the repo.\n/*\n    This file provides the provides functionality to get Microsoft Graph data.\n*/\nimport * as https from \"https\";\nimport { getAccessToken } from \"./ssoauth-helper\";\nimport * as createError from \"http-errors\";\n\n/* global process */\n\nconst domain = \"graph.microsoft.com\";\nconst version = \"v1.0\";\n\nexport async function getUserData(req, res, next) {\n  const authorization = req.get(\"Authorization\");\n\n  await getAccessToken(authorization)\n    .then(async (graphTokenResponse) => {\n      if (graphTokenResponse && (graphTokenResponse.claims || graphTokenResponse.error)) {\n        res.send(graphTokenResponse);\n      } else {\n        const graphToken = graphTokenResponse.access_token;\n        const graphUrlSegment = process.env.GRAPH_URL_SEGMENT || \"/me\";\n        const graphQueryParamSegment = process.env.QUERY_PARAM_SEGMENT || \"\";\n\n        const graphData = await getGraphData(graphToken, graphUrlSegment, graphQueryParamSegment);\n\n        // If Microsoft Graph returns an error, such as invalid or expired token,\n        // there will be a code property in the returned object set to a HTTP status (e.g. 401).\n        // Relay it to the client. It will caught in the fail callback of `makeGraphApiCall`.\n        if (graphData.code) {\n          next(createError(graphData.code, \"Microsoft Graph error \" + JSON.stringify(graphData)));\n        } else {\n          res.send(graphData);\n        }\n      }\n    })\n    .catch((err) => {\n      res.status(401).send(err.message);\n      return;\n    });\n}\n\nexport async function getGraphData(accessToken, apiUrl, queryParams) {\n  return new Promise((resolve, reject) => {\n    const options = {\n      host: domain,\n      path: \"/\" + version + apiUrl + queryParams,\n      method: \"GET\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Accept: \"application/json\",\n        Authorization: \"Bearer \" + accessToken,\n        \"Cache-Control\": \"private, no-cache, no-store, must-revalidate\",\n        Expires: \"-1\",\n        Pragma: \"no-cache\",\n      },\n    };\n\n    https\n      .get(options, (response) => {\n        let body = \"\";\n        response.on(\"data\", (d) => {\n          body += d;\n        });\n        response.on(\"end\", () => {\n          // The response from the OData endpoint might be an error, say a\n          // 401 if the endpoint requires an access token and it was invalid\n          // or expired. But a message is not an error in the call of https.get,\n          // so the \"on('error', reject)\" line below isn't triggered.\n          // So, the code distinguishes success (200) messages from error\n          // messages and sends a JSON object to the caller with either the\n          // requested OData or error information.\n\n          let error;\n          if (response.statusCode === 200) {\n            let parsedBody = JSON.parse(body);\n            resolve(parsedBody);\n          } else {\n            error = new Error();\n            error.code = response.statusCode;\n            error.message = response.statusMessage;\n\n            // The error body sometimes includes an empty space\n            // before the first character, remove it or it causes an error.\n            body = body.trim();\n            error.bodyCode = JSON.parse(body).error.code;\n            error.bodyMessage = JSON.parse(body).error.message;\n            resolve(error);\n          }\n        });\n      })\n      .on(\"error\", reject);\n  });\n}\n","/*\n * Copyright (c) Microsoft. All rights reserved. Licensed under the MIT license. See full license in root of repo. -->\n *\n * This file defines the routes within the authRoute router.\n */\n\nimport fetch from \"node-fetch\";\nimport form from \"form-urlencoded\";\nimport jwt from \"jsonwebtoken\";\nimport { JwksClient } from \"jwks-rsa\";\n\n/* global process, console */\n\nconst DISCOVERY_KEYS_ENDPOINT = \"https://login.microsoftonline.com/common/discovery/v2.0/keys\";\n\nexport async function getAccessToken(authorization) {\n  if (!authorization) {\n    let error = new Error(\"No Authorization header was found.\");\n    return Promise.reject(error);\n  } else {\n    const scopeName = process.env.SCOPE || \"User.Read\";\n    const [, /* schema */ assertion] = authorization.split(\" \");\n\n    const tokenScopes = jwt.decode(assertion).scp.split(\" \");\n    const accessAsUserScope = tokenScopes.find((scope) => scope === \"access_as_user\");\n    if (!accessAsUserScope) {\n      throw new Error(\"Missing access_as_user\");\n    }\n\n    const formParams = {\n      client_id: process.env.CLIENT_ID,\n      client_secret: process.env.CLIENT_SECRET,\n      grant_type: \"urn:ietf:params:oauth:grant-type:jwt-bearer\",\n      assertion: assertion,\n      requested_token_use: \"on_behalf_of\",\n      scope: [scopeName].join(\" \"),\n    };\n\n    const stsDomain = \"https://login.microsoftonline.com\";\n    const tenant = \"common\";\n    const tokenURLSegment = \"oauth2/v2.0/token\";\n    const encodedForm = form(formParams);\n\n    const tokenResponse = await fetch(`${stsDomain}/${tenant}/${tokenURLSegment}`, {\n      method: \"POST\",\n      body: encodedForm,\n      headers: {\n        Accept: \"application/json\",\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n      },\n    });\n    const json = await tokenResponse.json();\n    return json;\n  }\n}\n\nexport function validateJwt(req, res, next) {\n  const authHeader = req.headers.authorization;\n  if (authHeader) {\n    const token = authHeader.split(\" \")[1];\n\n    const validationOptions = {\n      audience: process.env.CLIENT_ID,\n    };\n\n    jwt.verify(token, getSigningKeys, validationOptions, (err) => {\n      if (err) {\n        console.log(err);\n        return res.sendStatus(403);\n      }\n\n      next();\n    });\n  }\n}\n\nfunction getSigningKeys(header, callback) {\n  var client = new JwksClient({\n    jwksUri: DISCOVERY_KEYS_ENDPOINT,\n  });\n\n  client.getSigningKey(header.kid, function (err, key) {\n    callback(null, key.getPublicKey());\n  });\n}\n","module.exports = require(\"cookie-parser\");","module.exports = require(\"dotenv\");","module.exports = require(\"express\");","module.exports = require(\"form-urlencoded\");","module.exports = require(\"http-errors\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"jwks-rsa\");","module.exports = require(\"morgan\");","module.exports = require(\"node-fetch\");","module.exports = require(\"office-addin-dev-certs\");","module.exports = require(\"path\");","module.exports = require(\"https\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/*\n * Copyright (c) Microsoft. All rights reserved. Licensed under the MIT license. See full license in root of repo. -->\n *\n * This file is the main Node.js server file that defines the express middleware.\n */\n\nif (process.env.NODE_ENV !== \"production\") {\n  require(\"dotenv\").config();\n}\nimport * as createError from \"http-errors\";\nimport * as path from \"path\";\nimport * as cookieParser from \"cookie-parser\";\nimport * as logger from \"morgan\";\nimport express from \"express\";\nimport https from \"https\";\nimport { getHttpsServerOptions } from \"office-addin-dev-certs\";\nimport { getUserData } from \"./msgraph-helper\";\nimport { validateJwt } from \"./ssoauth-helper\";\n\n/* global console, process, require, __dirname */\n\nconst app = express();\nconst port = process.env.API_PORT || \"3000\";\nconsole.log(\"Using client_ID: \" + process.env.CLIENT_ID)\n\napp.set(\"port\", port);\n\n// view engine setup\napp.set(\"views\", path.join(__dirname, \"views\"));\napp.set(\"view engine\", \"pug\");\n\napp.use(logger(\"dev\"));\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\napp.use(cookieParser());\n\n/* Turn off caching when developing */\nif (process.env.NODE_ENV !== \"production\") {\n  app.use(express.static(path.join(process.cwd(), \"dist\"), { etag: false }));\n\n  app.use(function (req, res, next) {\n    res.header(\"Cache-Control\", \"private, no-cache, no-store, must-revalidate\");\n    res.header(\"Expires\", \"-1\");\n    res.header(\"Pragma\", \"no-cache\");\n    next();\n  });\n} else {\n  // In production mode, let static files be cached.\n  app.use(express.static(path.join(process.cwd(), \"dist\")));\n}\n\nconst indexRouter = express.Router();\nindexRouter.get(\"/\", function (req, res) {\n  res.render(\"/taskpane.html\");\n});\n\napp.use(\"/\", indexRouter);\n\n// Middle-tier API calls\n// listen for 'ping' to verify service is running\n// Un comment for development debugging, but un needed for production deployment\n// app.get(\"/ping\", function (req: any, res: any) {\n//   res.send(process.platform);\n// });\n\napp.get(\"/getuserdata\", validateJwt, getUserData);\n\n// Get the client side task pane files requested\napp.get(\"/taskpane.html\", async (req, res) => {\n  return res.sendfile(\"taskpane.html\");\n});\n\napp.get(\"/fallbackauthdialog.html\", async (req, res) => {\n  return res.sendfile(\"fallbackauthdialog.html\");\n});\n\n// Catch 404 and forward to error handler\napp.use(function (req, res, next) {\n  next(createError(404));\n});\n\n// error handler\napp.use(function (err, req, res) {\n  // set locals, only providing error in development\n  res.locals.message = err.message;\n  res.locals.error = req.app.get(\"env\") === \"development\" ? err : {};\n\n  // render the error page\n  res.status(err.status || 500);\n  res.render(\"error\");\n});\n\ngetHttpsServerOptions().then((options) => {\n  https\n    .createServer(options, app)\n    .listen(port, () => console.log(`Server running on ${port} in ${process.env.NODE_ENV} mode`));\n});\n"],"names":["https","getAccessToken","createError","domain","version","getUserData","req","res","next","authorization","get","then","graphTokenResponse","claims","error","send","graphToken","access_token","graphUrlSegment","process","env","GRAPH_URL_SEGMENT","graphQueryParamSegment","QUERY_PARAM_SEGMENT","getGraphData","graphData","code","JSON","stringify","catch","err","status","message","accessToken","apiUrl","queryParams","Promise","resolve","reject","options","host","path","method","headers","Accept","Authorization","Expires","Pragma","response","body","on","d","statusCode","parsedBody","parse","Error","statusMessage","trim","bodyCode","bodyMessage","fetch","form","jwt","JwksClient","DISCOVERY_KEYS_ENDPOINT","scopeName","SCOPE","split","assertion","tokenScopes","decode","scp","accessAsUserScope","find","scope","formParams","client_id","CLIENT_ID","client_secret","CLIENT_SECRET","grant_type","requested_token_use","join","stsDomain","tenant","tokenURLSegment","encodedForm","tokenResponse","json","validateJwt","authHeader","token","validationOptions","audience","verify","getSigningKeys","console","log","sendStatus","header","callback","client","jwksUri","getSigningKey","kid","key","getPublicKey","NODE_ENV","require","config","cookieParser","logger","express","getHttpsServerOptions","app","port","API_PORT","set","__dirname","use","urlencoded","extended","static","cwd","etag","indexRouter","Router","render","sendfile","locals","createServer","listen"],"sourceRoot":""}